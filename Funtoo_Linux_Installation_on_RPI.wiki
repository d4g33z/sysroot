== Introduction ==
This is an extension and amplification of [[Funtoo_Linux_Installation_on_ARM]]. It attempts to systematize and automate as much as possible of steps required to get Funtoo running on the 32 bit ARM Raspberry Pi device.

This is an update of [[Crossdev_Automation]], reflecting the changes needed to accomodate the new kits structure of Funtoo, and to clean up the scripting used for automation. The document will remain available for reference purposes. 


== Installation Overview ==
# [[#Create Your Installation Settings]]
# [[#Install the Stage 3 Tarball]]
# [[#Install the Firmware]]
# [[#Configure Your System]]
# [[#Install Binary Kernel, Modules and dtbs]]
# [[#Cross-compile Kernel, Modules and dtbs from Source]]
# [[#Optionally Install Distcc via QEMU Chroot]]
# [[#Partition and Format an SDCard]]
# [[#Deploy Installation to SDCard]]
# [[#Transfer the SDCard to the Raspberry Pi and Reboot]]

== Get the Bash Script ==

Development code is available on [https://github.com/d4g33z/sysroot.git github]. The structure of the file {{c|sysroot.sh}} should roughly correspond to the information contained here.

Too use the script, edit the {{c|config}} file and then
{{console|body=
###i## source sysroot.sh && sysroot_install
}}

== Follow the Installation Steps ==

=== Create Your Installation Settings ===

Confguration your installation. These variables are referencecd by the {{c|sysroot.sh}} script and by this document.

{{file|name=config|lang=bash|desc=Set your install configuration variables|body=
KERNEL_WORK=/usr/src/rpi_kernel
RPI_KERN_BRANCH=rpi-4.14.y

SYSROOT_WORK=/usr/src/sysroots
STAGE_URL=http://ftp.osuosl.org/pub/funtoo/funtoo-current/arm-32bit/raspi3/stage3-latest.tar.xz
CHOST=armv7a-hardfloat-linux-gnueabi
CFLAGS="-O2 -pipe -march=armv7-a -mtune=cortex-a53 -mfpu=neon-vfpv4 -mfloat-abi=hard"

#SDCARD_DEV=mmcblk0p
SDCARD_DEV=sdb

#optional
DISTCC_REMOTE_JOBS=21
DISTCC_REMOTE_HOSTS="10.0.0.1,cpp,lzo"
}}



=== Install the Stage 3 Tarball ===

Download the current Funtoo stage 3 build appropriate for your Raspberry Pi device. Check the [[Subarches#arm32]] page, to see the version available for versions 1,2 and 3 of the Pi. Here we download the version for version 3 by setting the STAGE_URL variable in our configuration file. 

We need to save the archive to {{c|$STAGE3_ARCHIVE}} and unpack it to {{c|$SYSROOT}}. Back up or remove any previous work in that local.

{{console|body=
###i## export SYSROOT=$SYSROOT_WORK/$CHOST
###i## export STAGE3_ARCHIVE=/tmp/stage3-latest.tar.xz
###i## mv -n $SYSROOT $SYSROOT.old
###i## mkdir -p $SYSROOT
###i## wget ${STAGE_URL} -O ${STAGE3_ARCHIVE}
###i## tar xpfv ${STAGE3_ARCHIVE} -C ${SYSROOT}
}}

=== Install the Firmware ===
Make your work directory and clone the official firmware repo into it. Copy the appropriate boot firmware files to the sysroot, along with the video acceleration binaries. If you want to use the wireless networking function, you need the bcrm firmware as well.

{{console|body=
###i## mkdir -p ${KERNEL_WORK}
###i## git clone --depth 1 git://github.com/raspberrypi/firmware/ ${KERNEL_WORK}/firmware
###i## cp ${KERNEL_WORK}/firmware/boot/{bootcode.bin,fixup*.dat,start*.elf} ${SYSROOT}/boot
###i## cp -r ${KERNEL_WORK}/firmware/hardfp/opt ${SYSROOT}
###i## git clone --depth 1 https://github.com/RPi-Distro/firmware-nonfree ${KERNEL_WORK}/firmware-nonfree
###i## git --git-dir=${KERNEL_WORK}/firmware-nonfree/.git --work-tree=${KERNEL_WORK}/firmware-nonfree pull origin
###i## mkdir -p ${SYSROOT}/lib/firmware/brcm
###i## cp -r ${KERNEL_WORK}/firmware-nonfree/brcm/brcmfmac43430-sdio.{bin,txt} ${SYSROOT}/lib/firmware/brcm
}}

=== Configure Your System ===
Here, we attempt to encapsulate the instructions from [[Funtoo_Linux_Installation_on_ARM]]. There are two ways to do this. Here we alter files and symlinks in {{c|$SYSROOT/etc}} directly. We could also chroot into $SYSROOT using QEMU as described below to install {{Package|sys-devel/distcc}}, use {{c|rc-update}} directly. However the method used here doesn't depend upon a functioning QEMU chroot, which can be slow and tricky to implement for beginners.

==== Set Up Mount Points ====
Alter {{c|$SYSROOT/etc/fstab}} as follows. We remove the swap (for now), and alter the storage device name and parition file types. We also remove the {{c|/dev/cdrom}} device.

{{file|name=$SYSROOT/etc/fstab|body=
/dev/mmcblk0p1  /boot   vfat    noauto,noatime  1 2
/dev/mmcblk0p2  /   ext4    noatime 0 1
}}

We can use the following {{Package|sys-apps/sed}} code.
{{console|body=
###i## sed -i "s/\/dev\/sda1.*/\/dev\/mmcblk0p1 \/boot vfat defaults 0 2/" ${SYSROOT}/etc/fstab
###i## sed -i "s/\/dev\/sda2.*//" ${SYSROOT}/etc/fstab
###i## sed -i "s/\/dev\/sda3.*/\/dev\/mmcblk0p2 \/ ext4  defaults 0 1/" ${SYSROOT}/etc/fstab
###i## sed -i "s/\#\/dev\/cdrom.*//" ${SYSROOT}/etc/fstab
}}

==== Set Up Root Password ====
{{console|body=
###i## sed -i "s/root\:\*/root\:`(openssl passwd -1)`/" $SYSROOT/etc/shadow
}}
==== Set Up Networking ====
{{console|body=
###i## ln -sf /etc/init.d/dhcpcd ${SYSROOT}/etc/runlevels/default
}}
==== Set Up SSH Access ====
{{console|body=
###i## echo "PermitRootLogin yes" >> ${SYSROOT}/etc/ssh/sshd_config
###i## ln -sf /etc/init.d/sshd ${SYSROOT}/etc/runlevels/default 
}}
==== Set Up the Software Clock ====
{{console|body=
###i## ln -sf /etc/init.d/swclock ${SYSROOT}/etc/runlevels/boot
###i## rm ${SYSROOT}/etc/runlevels/boot/hwclock
###i## mkdir -p ${SYSROOT}/lib/rc/cache
###i## touch ${SYSROOT}/lib/rc/cache/shutdowntime
}}
==== Disable Serial Console Access ====
If you want this, set it up yourself.
{{console|body=
###i## sed -i "s/s0\:.*/\#&/" ${SYSROOT}/etc/inittab
}}
==== Link to Accelerated Video Libraries ====
{{console|body=
###i## echo "LDPATH=\"/opt/vc/lib\"" > ${SYSROOT}/etc/env.d/99vc
}}
==== Configure the Boot Parameters ====
{{console|body=
###i## cat > ${SYSROOT}/boot/cmdline.txt << EOF
##i## dwc_otg.lpm_enable=0 console=tty1 root=/dev/mmcblk0p2 rootfstype=ext4 elevator=deadline fsck.repair=yes rootwait
##i## EOF
}}
=== Install Binary Kernel, Modules and dtbs ===
{{console|body=
###i## mkdir -p ${SYSROOT}/boot/overlays
###i## cp ${KERNEL_WORK}/firmware/boot/dts/*.dtb ${SYSROOT}/boot/
###i## cp ${KERNEL_WORK}/firmware/boot/dts/overlays/*.dtb* ${SYSROOT}/boot/overlays/
###i## cp ${KERNEL_WORK}/firmware/boot/dts/overlays/README ${SYSROOT}/boot/overlays/
###i## cp ${KERNEL_WORK}/firmware/boot/kernel7.img  ${SYSROOT}/boot/
}}
=== Cross-compile Kernel, Modules and dtbs from Source ===
==== Install Crossdev ====
{{Package|sys-devel/crossdev}} is a wonderful script for managing cross-compiling environments on Gentoo, but it is incompatible with Funtoo's improved gcc ebuilds. There is incomplete documentation of a pure Funtoo [https://bugs.funtoo.org/browse/FL-3787 solution], but there has been no follow up on a complete implementation.

A simple solution is to create a [[Local_Overlay|local overlay]] named "crossdev", store gentoo ebuilds and patches in it, and use a crossdev command line switch to direct it to search the overlay for the appropriate ebuilds. This has the advantage of isolating all gentoo files and resulting binaries in a single directory.~

{{note|
Please ensure that {{c|/etc/portage{package.keywords,package.mask,package.use} }} are all directories.
}}

===== Make a Local Local_Overlay =====
Let's follow the directions from [[Local_Overlay]], and remove the .git subdirectory.~
{{console|body=
###i## mkdir /var/git/overlay
###i## cd /var/git/overlay
###i## git clone  https://github.com/funtoo/skeleton-overlay.git crossdev
###i## rm -rf /var/git/overlay/crossdev/.git
###i## echo "crossdev" > /var/git/overlay/crossdev/profiles/repo_name
}}

Edit config files to match.
{{file|name=/etc/portage/repos.conf/crossdev.conf|lang=|desc=Add the crossdev overlay to portage|body=
[crossdev]
location = /var/git/overlay/crossdev
auto-sync = no
priority = 10
}}

===== Sparse Checkout Gentoo GCC Ebuilds =====
Let's make a [https://stackoverflow.com/questions/600079/how-do-i-clone-a-subdirectory-only-of-a-git-repository/28039894#28039894 sparse checkout] of the main Gentoo repo.

{{console|body=
###i## cd /var/git/overlay/crossdev
###i## git init
###i## git remote add origin git://github.com/gentoo/gentoo.git
###i## git config core.sparseCheckout true
###i## echo "sys-devel/gcc" >> .git/info/sparse-checkout
###i## git pull --depth=1 origin master
}}

===== Unmask and Emerge Crossdev =====
{{console|body=
###i## echo "sys-devel/crossdev **" >> /etc/portage/package.keywords/crossdev
###i## echo "=sys-devel/crossdev-99999999" >> /etc/portage/package.unmask/crossdev
###i## emerge crossdev
}}

==== Install Cross Compilation Tool Chain ====
{{console|body=
###i## crossdev -S --ov-gcc /var/git/overlay/crossdev -t ${CHOST}
}}

===== Retrive Raspberry Pi Kernel Sources =====
{{console|body=
###i## git clone https://github.com/raspberrypi/linux.git ${KERNEL_WORK}/linux
}}

==== Clean and Update Kernel Sources ====
{{console|body=
###i## git --git-dir=${KERNEL_WORK}/linux/.git --work-tree=${KERNEL_WORK}/linux clean -fdx
###i## git --git-dir=${KERNEL_WORK}/linux/.git --work-tree=${KERNEL_WORK}/linux checkout master
###i## git --git-dir=${KERNEL_WORK}/linux/.git --work-tree=${KERNEL_WORK}/linux fetch --all
###i## git --git-dir=${KERNEL_WORK}/linux/.git --work-tree=${KERNEL_WORK}/linux branch -D ${RPI_KERN_BRANCH}
###i## git --git-dir=${KERNEL_WORK}/linux/.git --work-tree=${KERNEL_WORK}/linux checkout ${RPI_KERN_BRANCH}
}}

==== Make the Default Config ====
{{console|body=
###i## make -j$(nproc) \
##i## ARCH=arm \
##i## CROSS_COMPILE=${CHOST}- \
##i## bcm2709_defconfig
}}

==== Configure the Kernel ====
{{console|body=
###i## make -j$(nproc) \
##i## ARCH=arm \
##i## CROSS_COMPILE=${CHOST}- \
##i## MENUCONFIG_COLOR=mono \
##i## menuconfig
}}

==== Build and Install the Kernel ====
{{console|body=
###i## cd ${KERNEL_WORK}/linux
}}

{{console|body=
###i## make -j$(nproc) \
##i## ARCH=arm \
##i## CROSS_COMPILE=${CHOST}- \
##i## zImage dtbs modules
}}

{{console|body=
###i## make -j$(nproc) \
##i## ARCH=arm \
##i## CROSS_COMPILE=${CHOST}- \
##i## INSTALL_MOD_PATH=${SYSROOT} \
##i## modules_install
}}

{{console|body=
###i## mkdir -p ${SYSROOT}/boot/overlays
##i## cp arch/arm/boot/dts/*.dtb ${SYSROOT}/boot/
##i## cp arch/arm/boot/dts/overlays/*.dtb* ${SYSROOT}/boot/overlays/
##i## cp arch/arm/boot/dts/overlays/README ${SYSROOT}/boot/overlays/
}}

{{console|body=
###i## scripts/mkknlimg arch/arm/boot/zImage ${SYSROOT}/boot/kernel7.img
}}

===== Remove Kernel Headers and Source Links =====
{{console|body=
###i## rm ${SYSROOT}/lib/modules/`get_kernel_release`/{build,source}
}}

===== Backup Kernel Config =====
{{console|body=
###i## mkdir -p ${SYSROOT}/etc/kernels
###i## cp -i ${KERNEL_WORK}/linux/.config ${SYSROOT}/etc/kernels
}}

=== Partition and Format an SDCard ===
{{console|body=
###i## export SDCARD=/dev/SDCARD_DEV
}}
==== Randomize SDCard ====
{{console|body=
###i## dd if=/dev/urandom of=${SDCARD} bs=1M status=progress
}}
==== Write Parition Scheme to SDCard ====
{{console|body=
###i## umount -Rl ${SDCARD}
###i## sfdisk --no-reread --wipe always ${SDCARD} << EOF
##i## label: dos
##i## unit: sectors
##i## ${SDCARD}1 : start=        2048, size=     1048576, type=c
##i## ${SDCARD}2 : start=     1050624, type=83
##i## EOF
}}
==== Format SDCard ====
Make sure you have {{Package|sys-fs/dosfstools}} installed.
{{console|body=
###i## mkfs.ext4 ${SDCARD}2
###i## mkfs.vfat ${SDCARD}1
}}

=== Deploy Installation to SDCard ===
{{console|body=
###i## mkdir -p /mnt/funtoo
###i## mount ${SDCARD}2 /mnt/funtoo
###i## mkdir -p /mnt/funtoo/boot
###i## mount ${SDCARD}1 /mnt/funtoo/boot
###i## rsync --archive \
##i##      --verbose \
##i##      --progress \
##i##      --exclude "var/git/*" \
##i##    ${SYSROOT}/{boot,bin,etc,home,lib,mnt,opt,root,run,sbin,srv,tmp,usr,var,dev} \
##i##    /mnt/funtoo/
###i## umount /mnt/rpi/boot
###i## umount /mnt/rpi
}}

=== Transfer SDCard to the Raspberry Pi and Reboot ===

